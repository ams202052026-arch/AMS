<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= business ? business.businessName : 'Dashboard' %> - Business</title>
    <link rel="icon" type="image/png" href="/image/favicon.png">
    <link rel="stylesheet" href="/css/scrollbar.css">
    <link rel="stylesheet" href="/css/businessOwner/dashboard-redesign.css">
</head>
<body>
    <div class="dashboard-layout">
        <!-- Mobile Header -->
        <header class="mobile-header">
            <div class="mobile-header-left">
                <img src="/image/logo.png" alt="AMS Logo" class="mobile-logo">
                <% if (business) { %>
                    <span class="mobile-business-name"><%= business.businessName %></span>
                <% } else { %>
                    <span class="mobile-business-name">No Business</span>
                <% } %>
            </div>
            <button class="mobile-menu-btn" onclick="toggleSidebar()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3 12H21M3 6H21M3 18H21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
        </header>

        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

        <!-- Sidebar -->
        <%- include('partials/sidebar', { currentPage: 'dashboard', user: user, business: business }) %>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card" data-kpi="today" data-value="<%= stats.todayAppointments %>" data-desc="Appointments scheduled for today">
                    <span class="stat-number"><%= stats.todayAppointments %></span>
                    <span class="stat-label">Today</span>
                </div>
                <div class="stat-card" data-kpi="pending" data-value="<%= stats.pendingAppointments %>" data-desc="Appointments waiting for your confirmation">
                    <span class="stat-number"><%= stats.pendingAppointments %></span>
                    <span class="stat-label">Pending</span>
                </div>
                <div class="stat-card" data-kpi="completed" data-value="<%= stats.completedAppointments %>" data-desc="Total appointments you have completed">
                    <span class="stat-number"><%= stats.completedAppointments %></span>
                    <span class="stat-label">Completed</span>
                </div>
                <div class="stat-card" data-kpi="revenue" data-value="‚Ç±<%= stats.totalRevenue.toLocaleString() %>" data-desc="Total revenue earned from all completed appointments">
                    <span class="stat-number">‚Ç±<%= stats.totalRevenue.toLocaleString() %></span>
                    <span class="stat-label">Total Revenue</span>
                </div>
                <div class="stat-card" data-kpi="services" data-value="<%= stats.totalServices %>" data-desc="Total number of services you offer">
                    <span class="stat-number"><%= stats.totalServices %></span>
                    <span class="stat-label">Services</span>
                </div>
                <div class="stat-card" data-kpi="team" data-value="<%= stats.totalStaff %>" data-desc="Total number of team members in your business">
                    <span class="stat-number"><%= stats.totalStaff %></span>
                    <span class="stat-label">Team Members</span>
                </div>
            </div>

            <!-- Team Performance -->
            <% if (staffPerformance && staffPerformance.length > 0) { %>
            <div class="card">
                <div class="card-header">
                    <h3>Team Performance</h3>
                    <a href="/business-owner/staff" class="btn btn-primary">Manage</a>
                </div>
                <div class="card-body">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th style="text-align: center;">Bookings</th>
                                <th style="text-align: center;">Done</th>
                                <th style="text-align: right;">Revenue</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% staffPerformance.slice(0, 5).forEach(staff => { %>
                            <tr>
                                <td><strong><%= staff.staffName %></strong></td>
                                <td style="text-align: center;"><%= staff.totalAppointments %></td>
                                <td style="text-align: center;"><%= staff.completedAppointments %></td>
                                <td style="text-align: right;">‚Ç±<%= staff.totalRevenue.toLocaleString() %></td>
                            </tr>
                            <% }) %>
                        </tbody>
                    </table>
                    
                    <!-- Mobile Cards -->
                    <div class="mobile-table-cards">
                        <% staffPerformance.slice(0, 5).forEach(staff => { %>
                        <div class="mobile-table-card">
                            <div class="mobile-table-row">
                                <span class="mobile-table-label">Name</span>
                                <span class="mobile-table-value"><strong><%= staff.staffName %></strong></span>
                            </div>
                            <div class="mobile-table-row">
                                <span class="mobile-table-label">Bookings</span>
                                <span class="mobile-table-value"><%= staff.totalAppointments %></span>
                            </div>
                            <div class="mobile-table-row">
                                <span class="mobile-table-label">Done</span>
                                <span class="mobile-table-value"><%= staff.completedAppointments %></span>
                            </div>
                            <div class="mobile-table-row">
                                <span class="mobile-table-label">Revenue</span>
                                <span class="mobile-table-value">‚Ç±<%= staff.totalRevenue.toLocaleString() %></span>
                            </div>
                        </div>
                        <% }) %>
                    </div>
                </div>
            </div>
            <% } %>

            <!-- Recent Bookings -->
            <div class="card">
                <div class="card-header">
                    <h3>Recent Bookings</h3>
                    <a href="/business-owner/appointments" class="btn btn-primary">View All</a>
                </div>
                <div class="card-body">
                    <% if (recentAppointments && recentAppointments.length > 0) { %>
                        <table>
                            <thead>
                                <tr>
                                    <th>Customer</th>
                                    <th>Service</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% recentAppointments.slice(0, 5).forEach(apt => { %>
                                <tr>
                                    <td><%= apt.customer ? apt.customer.fullName : 'N/A' %></td>
                                    <td><%= apt.service ? apt.service.name : 'N/A' %></td>
                                    <td><%= new Date(apt.date).toLocaleDateString() %></td>
                                    <td><%= apt.status %></td>
                                </tr>
                                <% }) %>
                            </tbody>
                        </table>
                        
                        <!-- Mobile Cards -->
                        <div class="mobile-table-cards">
                            <% recentAppointments.slice(0, 5).forEach(apt => { %>
                            <div class="mobile-table-card">
                                <div class="mobile-table-row">
                                    <span class="mobile-table-label">Customer</span>
                                    <span class="mobile-table-value"><%= apt.customer ? apt.customer.fullName : 'N/A' %></span>
                                </div>
                                <div class="mobile-table-row">
                                    <span class="mobile-table-label">Service</span>
                                    <span class="mobile-table-value"><%= apt.service ? apt.service.name : 'N/A' %></span>
                                </div>
                                <div class="mobile-table-row">
                                    <span class="mobile-table-label">Date</span>
                                    <span class="mobile-table-value"><%= new Date(apt.date).toLocaleDateString() %></span>
                                </div>
                                <div class="mobile-table-row">
                                    <span class="mobile-table-label">Status</span>
                                    <span class="mobile-table-value"><%= apt.status %></span>
                                </div>
                            </div>
                            <% }) %>
                        </div>
                    <% } else { %>
                        <div class="empty-state">
                            <div class="icon">üìÖ</div>
                            <p>No bookings yet</p>
                        </div>
                    <% } %>
                </div>
            </div>

            <!-- Apply for Business -->
            <% if (!business) { %>
            <div class="card">
                <div class="card-body">
                    <div class="empty-state">
                        <div class="icon">üè¢</div>
                        <h4 style="margin-bottom: 8px;">Start Your Business</h4>
                        <p style="margin-bottom: 24px;">Apply for verification to offer services</p>
                        <a href="/business-owner/apply" class="btn btn-primary">Apply Now</a>
                    </div>
                </div>
            </div>
            <% } %>
        </main>
    </div>

    <!-- KPI Modal -->
    <div class="kpi-modal" id="kpiModal" onclick="closeKPIModal()">
        <div class="kpi-modal-content" onclick="event.stopPropagation()">
            <button class="kpi-modal-close" onclick="closeKPIModal()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
            <div class="kpi-modal-body">
                <h3 id="kpiModalTitle"></h3>
                <div class="kpi-modal-value" id="kpiModalValue"></div>
                <p id="kpiModalDescription"></p>
            </div>
        </div>
    </div>

    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
            document.body.classList.toggle('sidebar-open');
        }

        // KPI Card Click Handlers
        document.addEventListener('DOMContentLoaded', function() {
            const statCards = document.querySelectorAll('.stat-card');
            statCards.forEach(card => {
                card.addEventListener('click', function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    
                    const type = this.dataset.kpi;
                    const value = this.dataset.value;
                    const description = this.dataset.desc;
                    
                    showKPIModal(type, value, description);
                });
            });
        });

        function showKPIModal(type, value, description) {
            const modal = document.getElementById('kpiModal');
            const titleMap = {
                'today': 'Today\'s Appointments',
                'pending': 'Pending Appointments',
                'completed': 'Completed Appointments',
                'revenue': 'Total Revenue',
                'services': 'Total Services',
                'team': 'Team Members'
            };
            
            document.getElementById('kpiModalTitle').textContent = titleMap[type] || 'KPI Details';
            document.getElementById('kpiModalValue').textContent = value;
            document.getElementById('kpiModalDescription').textContent = description;
            
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeKPIModal() {
            const modal = document.getElementById('kpiModal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }
    </script>
    <script src="/js/businessOwner/modals.js"></script>
</body>
</html>
