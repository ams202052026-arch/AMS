<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AMS Admin - Dashboard</title>
    <link rel="stylesheet" href="/css/admin/main.css">
    <link rel="stylesheet" href="/css/admin/dashboard.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="admin-layout">
        <%- include('partials/sidebar') %>

        <main class="admin-main">
            <header class="admin-header">
                <h1>Dashboard</h1>
                <span class="date"><%= new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) %></span>
            </header>

            <!-- Primary Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-icon">üìÖ</span>
                    <span class="stat-number"><%= stats.todayAppointments %></span>
                    <span class="stat-label">Today's Appointments</span>
                </div>
                <div class="stat-card pending">
                    <span class="stat-icon">‚è≥</span>
                    <span class="stat-number"><%= stats.pendingAppointments %></span>
                    <span class="stat-label">Pending Approval</span>
                </div>
                <div class="stat-card">
                    <span class="stat-icon">üè¢</span>
                    <span class="stat-number"><%= stats.totalBusinesses %></span>
                    <span class="stat-label">Total Businesses</span>
                </div>
                <div class="stat-card pending">
                    <span class="stat-icon">üîî</span>
                    <span class="stat-number"><%= stats.pendingBusinesses %></span>
                    <span class="stat-label">Pending Businesses</span>
                </div>
            </div>

            <!-- Secondary Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-icon">‚úÖ</span>
                    <span class="stat-number"><%= stats.approvedBusinesses %></span>
                    <span class="stat-label">Approved Businesses</span>
                </div>
                <div class="stat-card">
                    <span class="stat-icon">üë•</span>
                    <span class="stat-number"><%= stats.totalCustomers %></span>
                    <span class="stat-label">Total Customers</span>
                </div>
                <div class="stat-card">
                    <span class="stat-icon">üìä</span>
                    <span class="stat-number"><%= stats.completionRate %>%</span>
                    <span class="stat-label">Completion Rate</span>
                </div>
                <div class="stat-card">
                    <span class="stat-icon">üí∞</span>
                    <span class="stat-number">‚Ç±<%= stats.todayRevenue.toLocaleString() %></span>
                    <span class="stat-label">Today's Revenue</span>
                </div>
            </div>

            <!-- Revenue Stats -->
            <div class="revenue-grid">
                <div class="revenue-card">
                    <div class="revenue-header">
                        <span class="revenue-icon">üí∞</span>
                        <span class="revenue-label">Today's Revenue</span>
                    </div>
                    <span class="revenue-amount">‚Ç±<%= stats.todayRevenue.toLocaleString() %></span>
                </div>
                <div class="revenue-card highlight">
                    <div class="revenue-header">
                        <span class="revenue-icon">üìä</span>
                        <span class="revenue-label">This Month's Revenue</span>
                    </div>
                    <span class="revenue-amount">‚Ç±<%= stats.monthRevenue.toLocaleString() %></span>
                </div>
                <div class="revenue-card">
                    <div class="revenue-header">
                        <span class="revenue-icon">‚úÖ</span>
                        <span class="revenue-label">Completion Rate</span>
                    </div>
                    <span class="revenue-amount"><%= stats.completionRate %>%</span>
                    <span class="revenue-detail"><%= stats.completedAppointments %> of <%= stats.totalAppointments %> completed</span>
                </div>
                <div class="revenue-card">
                    <div class="revenue-header">
                        <span class="revenue-icon">‚ùå</span>
                        <span class="revenue-label">Cancellation Rate</span>
                    </div>
                    <span class="revenue-amount"><%= stats.cancellationRate %>%</span>
                    <span class="revenue-detail"><%= stats.cancelledAppointments %> cancelled</span>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="charts-section">
                <div class="chart-card">
                    <h2>Appointments Trend (Last 7 Days)</h2>
                    <canvas id="appointmentsChart"></canvas>
                </div>
            </div>

            <!-- Quick Actions for Pending Appointments -->
            <% if (pendingAppointmentsList.length > 0) { %>
            <section class="quick-actions-section">
                <h2>‚ö° Quick Actions - Pending Approvals</h2>
                <div class="pending-actions-grid">
                    <% pendingAppointmentsList.forEach(apt => { %>
                        <div class="pending-action-card">
                            <div class="pending-info">
                                <span class="queue-badge"><%= apt.queueNumber %></span>
                                <div class="pending-details">
                                    <strong><%= apt.customer ? apt.customer.name : 'N/A' %></strong>
                                    <span class="service-name"><%= apt.service ? apt.service.name : 'N/A' %></span>
                                    <span class="appointment-date">
                                        <%= new Date(apt.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) %> 
                                        at <%= apt.timeSlot.start %>
                                    </span>
                                </div>
                            </div>
                            <div class="pending-actions">
                                <form action="/admin/appointments/<%= apt._id %>/approve" method="POST" style="display: inline;">
                                    <button type="submit" class="btn-sm btn-success" title="Approve">‚úì</button>
                                </form>
                                <form action="/admin/appointments/<%= apt._id %>/cancel" method="POST" style="display: inline;">
                                    <button type="submit" class="btn-sm btn-danger" title="Cancel">‚úó</button>
                                </form>
                            </div>
                        </div>
                    <% }) %>
                </div>
                <a href="/admin/appointments?status=pending" class="view-all-link">View All Pending ‚Üí</a>
            </section>
            <% } %>

            <div class="dashboard-grid">
                <!-- Recent Appointments -->
                <section class="recent-appointments">
                    <h2>Recent Appointments</h2>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Queue</th>
                                <th>Customer</th>
                                <th>Service</th>
                                <th>Staff</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% recentAppointments.forEach(apt => { %>
                                <tr>
                                    <td><%= apt.queueNumber %></td>
                                    <td><%= apt.customer ? apt.customer.name : 'N/A' %></td>
                                    <td><%= apt.service ? apt.service.name : 'N/A' %></td>
                                    <td><%= apt.staff ? apt.staff.name : 'Unassigned' %></td>
                                    <td><span class="status-badge <%= apt.status %>"><%= apt.status %></span></td>
                                </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </section>

                <!-- Popular Services -->
                <section class="popular-services">
                    <h2>üî• Popular Services</h2>
                    <div class="services-list">
                        <% popularServices.forEach((service, index) => { %>
                            <div class="service-item">
                                <span class="service-rank">#<%= index + 1 %></span>
                                <div class="service-info">
                                    <strong><%= service.name %></strong>
                                    <span class="service-stats">
                                        <%= service.count %> bookings ‚Ä¢ ‚Ç±<%= service.revenue.toLocaleString() %>
                                    </span>
                                </div>
                            </div>
                        <% }) %>
                    </div>
                </section>
            </div>

            <!-- Business Performance -->
            <section class="business-performance-section">
                <h2>‚≠ê Top Performing Businesses</h2>
                <div class="performance-grid">
                    <% if (typeof businessPerformance !== 'undefined' && businessPerformance.length > 0) { %>
                        <% businessPerformance.forEach((business, index) => { %>
                            <div class="performance-card">
                                <span class="performance-rank">#<%= index + 1 %></span>
                                <div class="performance-info">
                                    <strong><%= business.businessName %></strong>
                                    <span class="performance-count"><%= business.appointmentsCompleted %> completed</span>
                                </div>
                                <div class="performance-badge">
                                    <% if (index === 0) { %>ü•á
                                    <% } else if (index === 1) { %>ü•à
                                    <% } else if (index === 2) { %>ü•â
                                    <% } else { %>‚≠ê<% } %>
                                </div>
                            </div>
                        <% }) %>
                    <% } else { %>
                        <div class="performance-card">
                            <div class="performance-info">
                                <strong>No business performance data available</strong>
                                <span class="performance-count">Businesses will appear here once they start completing appointments</span>
                            </div>
                        </div>
                    <% } %>
                </div>
            </section>
        </main>
    </div>

    <script>
        // Appointments Trend Chart
        const ctx = document.getElementById('appointmentsChart').getContext('2d');
        const chartData = <%- JSON.stringify(chartData) %>;
        
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartData.map(d => d.date),
                datasets: [{
                    label: 'Appointments',
                    data: chartData.map(d => d.count),
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointBackgroundColor: '#667eea',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 5,
                    pointHoverRadius: 7
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: '#2d3436',
                        padding: 12,
                        titleFont: {
                            size: 14
                        },
                        bodyFont: {
                            size: 13
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        },
                        grid: {
                            color: '#f0f0f0'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    </script>
</body>
</html>
