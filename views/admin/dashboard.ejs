<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - AMS</title>
    <link rel="icon" type="image/png" href="/image/favicon.png">
    <link rel="stylesheet" href="/css/scrollbar.css">
    <link rel="stylesheet" href="/css/admin/main.css">
    <link rel="stylesheet" href="/css/admin/dashboard-redesign.css">
</head>
<body>
    <div class="dashboard-layout">
        <%- include('partials/sidebar') %>

        <main class="main-content">
            <!-- Header -->
            <div class="dashboard-header">
                <h1>Dashboard</h1>
                <p class="date"><%= new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) %></p>
            </div>

            <!-- Key Metrics -->
            <div class="stats-grid">
                <div class="stat-card" data-kpi="users" data-value="<%= stats.totalUsers.toLocaleString() %>" data-desc="Total number of registered customers in the system (excluding super admin accounts)">
                    <span class="stat-number"><%= stats.totalUsers.toLocaleString() %></span>
                    <span class="stat-label">Total Users</span>
                </div>
                <div class="stat-card" data-kpi="businesses" data-value="<%= stats.totalBusinesses.toLocaleString() %>" data-desc="Total number of registered businesses in the system, including pending, approved, and suspended businesses">
                    <span class="stat-number"><%= stats.totalBusinesses.toLocaleString() %></span>
                    <span class="stat-label">Total Businesses</span>
                </div>
                <div class="stat-card highlight" data-kpi="pending" data-value="<%= stats.pendingBusinessApplications.toLocaleString() %>" data-desc="Number of business applications waiting for admin approval. These businesses need to be reviewed and verified">
                    <span class="stat-number"><%= stats.pendingBusinessApplications.toLocaleString() %></span>
                    <span class="stat-label">Pending Applications</span>
                </div>
                <div class="stat-card" data-kpi="bookings" data-value="<%= stats.totalAppointments.toLocaleString() %>" data-desc="Total number of appointments/bookings made across all businesses in the system">
                    <span class="stat-number"><%= stats.totalAppointments.toLocaleString() %></span>
                    <span class="stat-label">Total Bookings</span>
                </div>
                <div class="stat-card" data-kpi="rewards" data-value="<%= stats.activeRewards.toLocaleString() %>" data-desc="Number of active reward programs available for customers to redeem using their loyalty points">
                    <span class="stat-number"><%= stats.activeRewards.toLocaleString() %></span>
                    <span class="stat-label">Active Rewards</span>
                </div>
            </div>

            <!-- Business Overview -->
            <div class="section">
                <div class="section-header">
                    <h2>Business Overview</h2>
                </div>
                
                <div class="overview-grid">
                    <div class="overview-card">
                        <span class="overview-number"><%= stats.pendingBusinessApplications %></span>
                        <span class="overview-label">Pending Verifications</span>
                    </div>
                    <div class="overview-card">
                        <span class="overview-number"><%= recentlyApproved.length %></span>
                        <span class="overview-label">Recently Approved</span>
                    </div>
                    <div class="overview-card">
                        <span class="overview-number"><%= stats.suspendedRejected %></span>
                        <span class="overview-label">Suspended/Rejected</span>
                    </div>
                </div>

                <!-- Pending Verifications -->
                <% if (pendingVerifications.length > 0) { %>
                <div class="card">
                    <div class="card-header">
                        <h3>Pending Verifications</h3>
                        <a href="/admin/businesses?status=pending" class="btn btn-primary">View All</a>
                    </div>
                    <div class="card-body">
                        <table>
                            <thead>
                                <tr>
                                    <th>Business Name</th>
                                    <th>Owner</th>
                                    <th>Type</th>
                                    <th>Applied</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% pendingVerifications.forEach(business => { %>
                                <tr onclick="window.location.href='/admin/businesses/<%= business._id %>'">
                                    <td><strong><%= business.businessName %></strong></td>
                                    <td><%= business.ownerId ? business.ownerId.firstName + ' ' + business.ownerId.lastName : 'N/A' %></td>
                                    <td><%= business.businessType %></td>
                                    <td><%= new Date(business.createdAt).toLocaleDateString() %></td>
                                </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>
                </div>
                <% } %>

                <!-- Business Growth Chart -->
                <div class="card">
                    <div class="card-header">
                        <h3>Business Growth (6 Months)</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="businessGrowthChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Management Stats -->
            <div class="section">
                <div class="section-header">
                    <h2>User Management</h2>
                </div>
                
                <div class="overview-grid">
                    <div class="overview-card">
                        <span class="overview-number"><%= stats.newUsersThisWeek %></span>
                        <span class="overview-label">New Users (This Week)</span>
                    </div>
                    <div class="overview-card">
                        <span class="overview-number"><%= stats.newUsersThisMonth %></span>
                        <span class="overview-label">New Users (This Month)</span>
                    </div>
                    <div class="overview-card">
                        <span class="overview-number"><%= stats.bannedUsers %></span>
                        <span class="overview-label">Banned Users</span>
                    </div>
                    <div class="overview-card">
                        <span class="overview-number"><%= stats.activeUsers %></span>
                        <span class="overview-label">Active Users</span>
                    </div>
                </div>

                <!-- User Growth Chart -->
                <div class="card">
                    <div class="card-header">
                        <h3>User Growth (6 Months)</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="userGrowthChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top Performing Businesses -->
            <div class="section">
                <div class="section-header">
                    <h2>Top Performing Businesses</h2>
                </div>
                
                <% if (topBusinesses.length > 0) { %>
                <div class="card">
                    <div class="card-body">
                        <table>
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Business Name</th>
                                    <th style="text-align: center;">Bookings</th>
                                    <th style="text-align: right;">Revenue</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% topBusinesses.forEach((business, index) => { %>
                                <tr>
                                    <td><strong>#<%= index + 1 %></strong></td>
                                    <td><%= business.businessName %></td>
                                    <td style="text-align: center;"><%= business.totalAppointments %></td>
                                    <td style="text-align: right;">â‚±<%= business.totalRevenue.toLocaleString() %></td>
                                </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>
                </div>
                <% } else { %>
                <div class="card">
                    <div class="card-body">
                        <div class="empty-state">
                            <div class="icon">ðŸ“Š</div>
                            <p>No business performance data yet</p>
                        </div>
                    </div>
                </div>
                <% } %>
            </div>
        </main>
    </div>

    <!-- KPI Modal -->
    <div class="kpi-modal" id="kpiModal" onclick="closeKPIModal()">
        <div class="kpi-modal-content" onclick="event.stopPropagation()">
            <button class="kpi-modal-close" onclick="closeKPIModal()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
            <div class="kpi-modal-body">
                <h3 id="kpiModalTitle"></h3>
                <div class="kpi-modal-value" id="kpiModalValue"></div>
                <p id="kpiModalDescription"></p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Highlight active nav item
        document.addEventListener('DOMContentLoaded', function() {
            const currentPath = window.location.pathname;
            const navItems = document.querySelectorAll('.nav-item');
            
            navItems.forEach(item => {
                if (item.getAttribute('href') === currentPath) {
                    item.classList.add('active');
                }
            });

            // KPI Card Click Handlers
            const statCards = document.querySelectorAll('.stat-card');
            statCards.forEach(card => {
                card.addEventListener('click', function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    
                    const type = this.dataset.kpi;
                    const value = this.dataset.value;
                    const description = this.dataset.desc;
                    
                    showKPIModal(type, value, description);
                });
            });
        });

        function showKPIModal(type, value, description) {
            const modal = document.getElementById('kpiModal');
            const titleMap = {
                'users': 'Total Users',
                'businesses': 'Total Businesses',
                'pending': 'Pending Applications',
                'bookings': 'Total Bookings',
                'rewards': 'Active Rewards'
            };
            
            document.getElementById('kpiModalTitle').textContent = titleMap[type] || 'KPI Details';
            document.getElementById('kpiModalValue').textContent = value;
            document.getElementById('kpiModalDescription').textContent = description;
            
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeKPIModal() {
            const modal = document.getElementById('kpiModal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        // Business Growth Chart
        const businessGrowthCtx = document.getElementById('businessGrowthChart').getContext('2d');
        const businessGrowthData = <%- JSON.stringify(businessGrowth) %>;
        
        new Chart(businessGrowthCtx, {
            type: 'line',
            data: {
                labels: businessGrowthData.map(d => d.month),
                datasets: [{
                    label: 'New Businesses',
                    data: businessGrowthData.map(d => d.count),
                    borderColor: '#1a1a1a',
                    backgroundColor: 'rgba(26, 26, 26, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointBackgroundColor: '#1a1a1a',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#1a1a1a',
                        padding: 12,
                        titleFont: { size: 13, weight: '600' },
                        bodyFont: { size: 12 }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { stepSize: 1, color: '#666', font: { size: 11 } },
                        grid: { color: '#f0f0f0' }
                    },
                    x: {
                        ticks: { color: '#666', font: { size: 11 } },
                        grid: { display: false }
                    }
                }
            }
        });

        // User Growth Chart
        const userGrowthCtx = document.getElementById('userGrowthChart').getContext('2d');
        const userGrowthData = <%- JSON.stringify(userGrowth) %>;
        
        new Chart(userGrowthCtx, {
            type: 'bar',
            data: {
                labels: userGrowthData.map(d => d.month),
                datasets: [{
                    label: 'New Users',
                    data: userGrowthData.map(d => d.count),
                    backgroundColor: '#1a1a1a',
                    borderRadius: 6,
                    barThickness: 40
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#1a1a1a',
                        padding: 12,
                        titleFont: { size: 13, weight: '600' },
                        bodyFont: { size: 12 }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { stepSize: 1, color: '#666', font: { size: 11 } },
                        grid: { color: '#f0f0f0' }
                    },
                    x: {
                        ticks: { color: '#666', font: { size: 11 } },
                        grid: { display: false }
                    }
                }
            }
        });
    </script>
</body>
</html>
