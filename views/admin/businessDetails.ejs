<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= business.businessName %> - Business Details</title>
    <link rel="icon" type="image/png" href="/image/favicon.png">
    <link rel="stylesheet" href="/css/scrollbar.css">
    <link rel="stylesheet" href="/css/admin/main.css">
    <link rel="stylesheet" href="/css/admin/dashboard-redesign.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .info-label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .info-value {
            font-size: 14px;
            color: #1a1a1a;
            font-weight: 500;
        }
        
        .documents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
        }
        
        .document-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.2s;
        }
        
        .document-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .document-card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }
        
        .document-card-body {
            padding: 12px;
        }
        
        .document-card-body p {
            font-size: 13px;
            color: #666;
            margin: 0;
        }
        
        #map {
            height: 300px;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .action-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .action-buttons .btn {
            flex: 1;
            min-width: 150px;
        }
        
        .btn-approve {
            background: #4CAF50;
            color: white;
        }
        
        .btn-approve:hover {
            background: #45a049;
        }
        
        .btn-reject {
            background: #f44336;
            color: white;
        }
        
        .btn-reject:hover {
            background: #da190b;
        }
        
        .btn-suspend {
            background: #ff9800;
            color: white;
        }
        
        .btn-suspend:hover {
            background: #e68900;
        }
        
        .btn-reactivate {
            background: #2196F3;
            color: white;
        }
        
        .btn-reactivate:hover {
            background: #0b7dda;
        }
        
        .btn-delete {
            background: #9e9e9e;
            color: white;
        }
        
        .btn-delete:hover {
            background: #757575;
        }
    </style>
</head>
<body>
    <div class="dashboard-layout">
        <%- include('partials/sidebar') %>

        <main class="main-content">
            <!-- Header -->
            <div class="dashboard-header">
                <div>
                    <a href="/admin/businesses" style="color: #666; text-decoration: none; font-size: 14px; display: inline-block; margin-bottom: 8px;">
                        ‚Üê Back to Businesses
                    </a>
                    <h1><%= business.businessName %></h1>
                    <span class="status-badge status-<%= business.verificationStatus %>">
                        <%= business.verificationStatus %>
                    </span>
                </div>
            </div>

            <!-- Business Information -->
            <div class="card">
                <div class="card-header">
                    <h3>Business Information</h3>
                </div>
                <div class="card-body">
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Business Name</span>
                            <span class="info-value"><%= business.businessName %></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Business Type</span>
                            <span class="info-value"><%= business.businessType %></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Contact Number</span>
                            <span class="info-value"><%= business.contactNumber %></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Email</span>
                            <span class="info-value"><%= business.email || 'N/A' %></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Applied On</span>
                            <span class="info-value"><%= new Date(business.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) %></span>
                        </div>
                        <% if (business.verifiedAt) { %>
                        <div class="info-item">
                            <span class="info-label">Verified On</span>
                            <span class="info-value"><%= new Date(business.verifiedAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) %></span>
                        </div>
                        <% } %>
                    </div>
                    
                    <% if (business.description) { %>
                    <div class="info-item" style="margin-top: 16px;">
                        <span class="info-label">Description</span>
                        <span class="info-value"><%= business.description %></span>
                    </div>
                    <% } %>
                </div>
            </div>

            <!-- Owner Information -->
            <div class="card">
                <div class="card-header">
                    <h3>Owner Information</h3>
                </div>
                <div class="card-body">
                    <% if (business.ownerId) { %>
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">Name</span>
                                <span class="info-value"><%= business.ownerId.firstName %> <%= business.ownerId.lastName %></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Email</span>
                                <span class="info-value"><%= business.ownerId.email %></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Phone</span>
                                <span class="info-value"><%= business.ownerId.phoneNumber || 'N/A' %></span>
                            </div>
                        </div>
                    <% } else { %>
                        <div class="alert alert-warning">
                            <strong>‚ö†Ô∏è Owner Account Deleted</strong>
                            <p>The owner of this business has deleted their account. This business is now orphaned and should be removed from the system.</p>
                        </div>
                    <% } %>
                </div>
            </div>

            <!-- Address -->
            <div class="card">
                <div class="card-header">
                    <h3>Business Address</h3>
                </div>
                <div class="card-body">
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Street</span>
                            <span class="info-value"><%= business.address.street %></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Barangay</span>
                            <span class="info-value"><%= business.address.barangay %></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">City</span>
                            <span class="info-value"><%= business.address.city %></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Province</span>
                            <span class="info-value"><%= business.address.province %></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Postal Code</span>
                            <span class="info-value"><%= business.address.zipCode || 'N/A' %></span>
                        </div>
                    </div>
                    
                    <% if (business.location && business.location.coordinates) { %>
                    <div style="margin-top: 24px;">
                        <span class="info-label" style="display: block; margin-bottom: 12px;">Location on Map</span>
                        <div id="map"></div>
                    </div>
                    <% } %>
                </div>
            </div>

            <!-- Documents -->
            <% if (business.verificationDocuments && business.verificationDocuments.length > 0) { %>
            <div class="card">
                <div class="card-header">
                    <h3>Verification Documents</h3>
                </div>
                <div class="card-body">
                    <div class="documents-grid">
                        <% business.verificationDocuments.forEach((doc, index) => { %>
                        <div class="document-card">
                            <img src="<%= doc.fileUrl %>" alt="<%= doc.type %>" onclick="window.open('<%= doc.fileUrl %>', '_blank')" style="cursor: pointer;">
                            <div class="document-card-body">
                                <p style="text-transform: capitalize;"><%= doc.type ? doc.type.replace(/_/g, ' ') : 'Document ' + (index + 1) %></p>
                                <% if (doc.uploadedAt) { %>
                                <p style="font-size: 11px; color: #999; margin-top: 4px;">
                                    <%= new Date(doc.uploadedAt).toLocaleDateString() %>
                                </p>
                                <% } %>
                            </div>
                        </div>
                        <% }); %>
                    </div>
                </div>
            </div>
            <% } %>

            <!-- Rejection Reason -->
            <% if (business.verificationStatus === 'rejected' && business.rejectionReason) { %>
            <div class="card" style="border-left: 4px solid #f44336;">
                <div class="card-header">
                    <h3>Rejection Reason</h3>
                </div>
                <div class="card-body">
                    <p style="color: #721c24; margin: 0;"><%= business.rejectionReason %></p>
                </div>
            </div>
            <% } %>

            <!-- Actions -->
            <div class="card">
                <div class="card-header">
                    <h3>Actions</h3>
                </div>
                <div class="card-body">
                    <div class="action-buttons">
                        <% if (business.verificationStatus === 'pending') { %>
                            <button type="button" class="btn btn-approve" onclick="handleApprove()" style="flex: 1; min-width: 150px;">Approve</button>
                            <button class="btn btn-reject" onclick="showRejectModal()">Reject</button>
                        <% } %>
                        
                        <% if (business.verificationStatus === 'approved') { %>
                            <button class="btn btn-suspend" onclick="showSuspendModal()">Suspend</button>
                        <% } %>
                        
                        <% if (business.verificationStatus === 'suspended') { %>
                            <button type="button" class="btn btn-reactivate" onclick="handleReactivate()" style="flex: 1; min-width: 150px;">Reactivate</button>
                        <% } %>
                        
                        <button class="btn btn-delete" onclick="showDeleteModal()">Delete Business</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Reject Modal -->
    <div class="kpi-modal" id="rejectModal" onclick="closeModal('rejectModal')">
        <div class="kpi-modal-content" onclick="event.stopPropagation()" style="max-width: 600px;">
            <button class="kpi-modal-close" onclick="closeModal('rejectModal')">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
            <div class="kpi-modal-body">
                <h3>Reject Business Application</h3>
                <form id="rejectForm" onsubmit="handleReject(event)">
                    <div style="margin: 20px 0;">
                        <label for="rejectionReason" style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #1a1a1a;">
                            Reason for Rejection
                        </label>
                        <textarea 
                            id="rejectionReason" 
                            name="reason" 
                            required 
                            rows="4"
                            style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical;"
                            placeholder="Please provide a detailed reason for rejection..."
                        ></textarea>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button type="button" class="btn" onclick="closeModal('rejectModal')" style="flex: 1; background: #f5f5f5; color: #1a1a1a;">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-reject" style="flex: 1;">
                            Reject Business
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Suspend Modal -->
    <div class="kpi-modal" id="suspendModal" onclick="closeModal('suspendModal')">
        <div class="kpi-modal-content" onclick="event.stopPropagation()" style="max-width: 600px;">
            <button class="kpi-modal-close" onclick="closeModal('suspendModal')">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
            <div class="kpi-modal-body">
                <h3>Suspend Business</h3>
                <form id="suspendForm" onsubmit="handleSuspend(event)">
                    <div style="margin: 20px 0;">
                        <label for="suspensionReason" style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #1a1a1a;">
                            Reason for Suspension
                        </label>
                        <textarea 
                            id="suspensionReason" 
                            name="reason" 
                            required 
                            rows="4"
                            style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical;"
                            placeholder="Please provide a reason for suspension..."
                        ></textarea>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button type="button" class="btn" onclick="closeModal('suspendModal')" style="flex: 1; background: #f5f5f5; color: #1a1a1a;">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-suspend" style="flex: 1;">
                            Suspend Business
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Modal -->
    <div class="kpi-modal" id="deleteModal" onclick="closeModal('deleteModal')">
        <div class="kpi-modal-content" onclick="event.stopPropagation()">
            <button class="kpi-modal-close" onclick="closeModal('deleteModal')">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
            <div class="kpi-modal-body">
                <h3>Delete Business</h3>
                <p style="color: #666; margin: 20px 0;">Are you sure you want to delete this business? This action cannot be undone.</p>
                <div style="display: flex; gap: 12px;">
                    <button type="button" class="btn" onclick="closeModal('deleteModal')" style="flex: 1; background: #f5f5f5; color: #1a1a1a;">
                        Cancel
                    </button>
                    <button type="button" class="btn btn-delete" onclick="handleDelete()" style="flex: 1;">
                        Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="kpi-modal" id="successModal">
        <div class="kpi-modal-content" onclick="event.stopPropagation()">
            <div class="kpi-modal-body">
                <div style="text-align: center; margin-bottom: 20px;">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: #4CAF50;">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                        <path d="M8 12L11 15L16 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <h3 style="text-align: center;">Success</h3>
                <p id="successMessage" style="color: #666; margin: 20px 0; text-align: center;"></p>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div class="kpi-modal" id="errorModal" onclick="closeModal('errorModal')">
        <div class="kpi-modal-content" onclick="event.stopPropagation()">
            <button class="kpi-modal-close" onclick="closeModal('errorModal')">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
            <div class="kpi-modal-body">
                <div style="text-align: center; margin-bottom: 20px;">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: #f44336;">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                        <path d="M12 8V12M12 16H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </div>
                <h3 style="text-align: center;">Error</h3>
                <p id="errorMessage" style="color: #666; margin: 20px 0; text-align: center;"></p>
                <button type="button" class="btn" onclick="closeModal('errorModal')" style="width: 100%; background: #f5f5f5; color: #1a1a1a;">
                    Close
                </button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Highlight active nav item
        document.addEventListener('DOMContentLoaded', function() {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                if (item.getAttribute('href') === '/admin/businesses') {
                    item.classList.add('active');
                }
            });

            // Initialize map if coordinates exist
            <% if (business.location && business.location.coordinates) { %>
                const map = L.map('map').setView([<%= business.location.coordinates[1] %>, <%= business.location.coordinates[0] %>], 15);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(map);
                
                L.marker([<%= business.location.coordinates[1] %>, <%= business.location.coordinates[0] %>])
                    .addTo(map)
                    .bindPopup('<b><%= business.businessName %></b><br><%= business.address.street %>')
                    .openPopup();
            <% } %>
        });

        function showRejectModal() {
            document.getElementById('rejectModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function showSuspendModal() {
            document.getElementById('suspendModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function showDeleteModal() {
            document.getElementById('deleteModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            document.body.style.overflow = '';
        }

        // AJAX Handler Functions
        const businessId = '<%= business._id %>';

        async function handleApprove() {
            try {
                const response = await fetch(`/admin/businesses/${businessId}/approve`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    showSuccessModal('Business approved successfully! The owner has been notified.');
                } else {
                    showErrorModal(data.error || 'Failed to approve business');
                }
            } catch (error) {
                console.error('Error:', error);
                showErrorModal('An error occurred while approving the business');
            }
        }

        async function handleReject(event) {
            event.preventDefault();
            const form = event.target;
            const reason = form.querySelector('[name="reason"]').value;

            try {
                const response = await fetch(`/admin/businesses/${businessId}/reject`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reason })
                });

                const data = await response.json();

                if (data.success) {
                    closeModal('rejectModal');
                    showSuccessModal('Business application rejected. The owner has been notified. Redirecting to businesses list...', true);
                    setTimeout(() => {
                        window.location.href = '/admin/businesses';
                    }, 2000);
                } else {
                    showErrorModal(data.error || 'Failed to reject business');
                }
            } catch (error) {
                console.error('Error:', error);
                showErrorModal('An error occurred while rejecting the business');
            }
        }

        async function handleSuspend(event) {
            event.preventDefault();
            const form = event.target;
            const reason = form.querySelector('[name="reason"]').value;

            try {
                const response = await fetch(`/admin/businesses/${businessId}/suspend`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reason })
                });

                const data = await response.json();

                if (data.success) {
                    closeModal('suspendModal');
                    showSuccessModal('Business suspended successfully. All services have been deactivated and the owner has been notified.');
                } else {
                    showErrorModal(data.error || 'Failed to suspend business');
                }
            } catch (error) {
                console.error('Error:', error);
                showErrorModal('An error occurred while suspending the business');
            }
        }

        async function handleReactivate() {
            try {
                const response = await fetch(`/admin/businesses/${businessId}/reactivate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    showSuccessModal('Business reactivated successfully! All services have been activated and the owner has been notified.');
                } else {
                    showErrorModal(data.error || 'Failed to reactivate business');
                }
            } catch (error) {
                console.error('Error:', error);
                showErrorModal('An error occurred while reactivating the business');
            }
        }

        async function handleDelete() {
            console.log('üóëÔ∏è Delete button clicked, businessId:', businessId);
            try {
                console.log('üì§ Sending DELETE request...');
                const response = await fetch(`/admin/businesses/${businessId}/delete`, {
                    method: 'DELETE',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });

                console.log('üì• Response received:', response.status, response.statusText);
                const data = await response.json();
                console.log('üì¶ Response data:', data);

                if (data.success) {
                    console.log('‚úÖ Delete successful, showing success modal');
                    closeModal('deleteModal');
                    showSuccessModal('Business deleted successfully. Redirecting to businesses list...', true);
                    setTimeout(() => {
                        console.log('üîÑ Redirecting to /admin/businesses');
                        window.location.href = '/admin/businesses';
                    }, 2000);
                } else {
                    console.log('‚ùå Delete failed:', data.error);
                    closeModal('deleteModal');
                    showErrorModal(data.error || 'Failed to delete business');
                }
            } catch (error) {
                console.error('üí• Error in handleDelete:', error);
                closeModal('deleteModal');
                showErrorModal('An error occurred while deleting the business');
            }
        }

        function showSuccessModal(message, noReload = false) {
            document.getElementById('successMessage').textContent = message;
            document.getElementById('successModal').classList.add('active');
            document.body.style.overflow = 'hidden';
            
            if (!noReload) {
                // Auto reload after 2 seconds
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            }
        }

        function showErrorModal(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }
    </script>
</body>
</html>
