<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AMS Admin - Appointments</title>
    <link rel="stylesheet" href="/css/admin/main.css">
    <link rel="stylesheet" href="/css/admin/appointments.css">
</head>
<body>
    <div class="admin-layout">
        <%- include('../partials/sidebar') %>

        <main class="admin-main">
            <header class="admin-header">
                <h1>Appointments</h1>
                <button class="btn-primary" onclick="openWalkInModal()">+ Add Walk-in</button>
            </header>

            <div class="filters">
                <form action="/admin/appointments" method="GET" class="filter-form">
                    <select name="status">
                        <option value="">All Status</option>
                        <option value="pending" <%= filters.status === 'pending' ? 'selected' : '' %>>Pending</option>
                        <option value="approved" <%= filters.status === 'approved' ? 'selected' : '' %>>Approved</option>
                        <option value="in-progress" <%= filters.status === 'in-progress' ? 'selected' : '' %>>In Progress</option>
                        <option value="completed" <%= filters.status === 'completed' ? 'selected' : '' %>>Completed</option>
                        <option value="cancelled" <%= filters.status === 'cancelled' ? 'selected' : '' %>>Cancelled</option>
                    </select>
                    <input type="date" name="date" value="<%= filters.date || '' %>">
                    <select name="staff">
                        <option value="">All Staff</option>
                        <% staffList.forEach(s => { %>
                            <option value="<%= s._id %>" <%= filters.staff === s._id.toString() ? 'selected' : '' %>><%= s.name %></option>
                        <% }) %>
                    </select>
                    <button type="submit" class="btn-secondary">Filter</button>
                </form>
            </div>

            <table class="data-table">
                <thead>
                    <tr>
                        <th>Queue #</th>
                        <th>Customer</th>
                        <th>Service</th>
                        <th>Date/Time</th>
                        <th>Staff</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <% appointments.forEach(apt => { %>
                        <tr>
                            <td><%= apt.queueNumber %></td>
                            <td><%= apt.customer ? apt.customer.name : 'N/A' %></td>
                            <td><%= apt.service ? apt.service.name : 'N/A' %></td>
                            <td>
                                <%= new Date(apt.date).toLocaleDateString() %><br>
                                <small><%= apt.timeSlot.startFormatted %> - <%= apt.timeSlot.endFormatted %></small>
                            </td>
                            <td>
                                <% if (apt.staff) { %>
                                    <%= apt.staff.name %>
                                <% } else { %>
                                    <form action="/admin/appointments/<%= apt._id %>/assign-staff" method="POST" class="inline-form">
                                        <select name="staffId" onchange="this.form.submit()">
                                            <option value="">Assign...</option>
                                            <% staffList.forEach(s => { %>
                                                <option value="<%= s._id %>"><%= s.name %></option>
                                            <% }) %>
                                        </select>
                                    </form>
                                <% } %>
                            </td>
                            <td><span class="status-badge <%= apt.status %>"><%= apt.status %></span></td>
                            <td class="actions">
                                <% if (apt.status === 'pending') { %>
                                    <form action="/admin/appointments/<%= apt._id %>/approve" method="POST" class="inline-form">
                                        <button type="submit" class="btn-sm btn-success">Approve</button>
                                    </form>
                                <% } %>
                                <% if (apt.status === 'approved' || apt.status === 'in-progress') { %>
                                    <form action="/admin/appointments/<%= apt._id %>/complete" method="POST" class="inline-form">
                                        <button type="submit" class="btn-sm btn-success">Complete</button>
                                    </form>
                                <% } %>
                                <% if (apt.status !== 'completed' && apt.status !== 'cancelled') { %>
                                    <form action="/admin/appointments/<%= apt._id %>/cancel" method="POST" class="inline-form">
                                        <button type="submit" class="btn-sm btn-danger">Cancel</button>
                                    </form>
                                <% } %>
                                <% if (apt.status === 'completed' || apt.status === 'cancelled') { %>
                                    <form action="/admin/appointments/<%= apt._id %>/delete" method="POST" class="inline-form" onsubmit="return confirm('Are you sure you want to delete this appointment? This action cannot be undone.')">
                                        <button type="submit" class="btn-sm btn-danger">Delete</button>
                                    </form>
                                <% } %>
                            </td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        </main>
    </div>

    <!-- Walk-in Modal -->
    <div id="walkInModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeWalkInModal()">&times;</span>
            <h2>Add Walk-in Customer</h2>
            <form action="/admin/appointments/walk-in" method="POST">
                <div class="form-group">
                    <label>Customer Name</label>
                    <input type="text" name="customerName" required>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" name="customerEmail" required>
                </div>
                <div class="form-group">
                    <label>Service</label>
                    <select name="serviceId" required>
                        <option value="">Select Service</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Staff</label>
                    <select name="staffId">
                        <option value="">Any Available</option>
                        <% staffList.forEach(s => { %>
                            <option value="<%= s._id %>"><%= s.name %></option>
                        <% }) %>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea name="notes"></textarea>
                </div>
                <button type="submit" class="btn-primary">Add to Queue</button>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal-overlay" style="display: none;">
        <div class="modal-box">
            <span class="close-btn" onclick="closeConfirmModal()">&times;</span>
            <h3 id="confirmTitle"></h3>
            <p id="confirmMessage"></p>
            
            <div class="modal-actions">
                <button type="button" class="btn-secondary" onclick="closeConfirmModal()">Hindi, Bumalik</button>
                <button type="button" id="confirmBtn"></button>
            </div>
        </div>
    </div>

    <script src="/js/admin/appointments.js"></script>
    <script src="/js/admin-confirmations.js"></script>
</body>
</html>
