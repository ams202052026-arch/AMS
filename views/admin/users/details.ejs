<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= user.firstName %> <%= user.lastName %> - User Details</title>
    <link rel="icon" type="image/png" href="/image/favicon.png">
    <link rel="stylesheet" href="/css/scrollbar.css">
    <link rel="stylesheet" href="/css/admin/main.css">
    <link rel="stylesheet" href="/css/admin/dashboard-redesign.css">
</head>
<body>
    <div class="dashboard-layout">
        <%- include('../partials/sidebar') %>

        <main class="main-content">
            <!-- Header with Back Button -->
            <div class="dashboard-header" style="display: flex; align-items: center; gap: 16px;">
                <a href="/admin/users" style="display: flex; align-items: center; text-decoration: none; color: #666; font-size: 14px; font-weight: 500;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px;">
                        <path d="M19 12H5M5 12L12 19M5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Back to Users
                </a>
            </div>

            <!-- User Header Card -->
            <div class="card" style="margin-bottom: 24px;">
                <div class="card-body" style="padding: 32px;">
                    <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 24px;">
                        <div style="flex: 1; min-width: 300px;">
                            <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px;">
                                <div style="width: 64px; height: 64px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: 600;">
                                    <%= user.firstName.charAt(0) %><%= user.lastName.charAt(0) %>
                                </div>
                                <div>
                                    <h1 style="margin: 0 0 8px 0; font-size: 28px;"><%= user.firstName %> <%= user.lastName %></h1>
                                    <div style="display: flex; gap: 8px; align-items: center;">
                                        <% if (user.isBanned) { %>
                                            <span class="status-badge status-rejected">Banned</span>
                                        <% } else if (user.isActive) { %>
                                            <span class="status-badge status-approved">Active</span>
                                        <% } else { %>
                                            <span class="status-badge status-suspended">Inactive</span>
                                        <% } %>
                                        <span class="status-badge status-pending"><%= user.role === 'customer' ? 'Customer' : 'Business Owner' %></span>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 24px;">
                                <div>
                                    <div style="display: flex; align-items: center; gap: 8px; color: #666; font-size: 13px; margin-bottom: 4px;">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M3 8L10.89 13.26C11.2187 13.4793 11.6049 13.5963 12 13.5963C12.3951 13.5963 12.7813 13.4793 13.11 13.26L21 8M5 19H19C19.5304 19 20.0391 18.7893 20.4142 18.4142C20.7893 18.0391 21 17.5304 21 17V7C21 6.46957 20.7893 5.96086 20.4142 5.58579C20.0391 5.21071 19.5304 5 19 5H5C4.46957 5 3.96086 5.21071 3.58579 5.58579C3.21071 5.96086 3 6.46957 3 7V17C3 17.5304 3.21071 18.0391 3.58579 18.4142C3.96086 18.7893 4.46957 19 5 19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        Email
                                    </div>
                                    <div style="font-weight: 500;"><%= user.email %></div>
                                </div>
                                <div>
                                    <div style="display: flex; align-items: center; gap: 8px; color: #666; font-size: 13px; margin-bottom: 4px;">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M8 7V3M16 7V3M7 11H17M5 21H19C19.5304 21 20.0391 20.7893 20.4142 20.4142C20.7893 20.0391 21 19.5304 21 19V7C21 6.46957 20.7893 5.96086 20.4142 5.58579C20.0391 5.21071 19.5304 5 19 5H5C4.46957 5 3.96086 5.21071 3.58579 5.58579C3.21071 5.96086 3 6.46957 3 7V19C3 19.5304 3.21071 20.0391 3.58579 20.4142C3.96086 20.7893 4.46957 21 5 21Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        Joined
                                    </div>
                                    <div style="font-weight: 500;"><%= new Date(user.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) %></div>
                                </div>
                                <div>
                                    <div style="display: flex; align-items: center; gap: 8px; color: #666; font-size: 13px; margin-bottom: 4px;">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M12 8V12L15 15M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        Last Login
                                    </div>
                                    <div style="font-weight: 500;"><%= user.lastLogin ? new Date(user.lastLogin).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) : 'Never' %></div>
                                </div>
                            </div>
                            
                            <% if (user.isBanned) { %>
                                <div style="margin-top: 24px; padding: 16px; background: #ffebee; border-left: 4px solid #f44336; border-radius: 8px;">
                                    <div style="display: flex; align-items: start; gap: 12px;">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: #f44336; flex-shrink: 0; margin-top: 2px;">
                                            <path d="M12 9V13M12 17H12.01M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        <div>
                                            <div style="font-weight: 600; color: #c62828; margin-bottom: 4px;">User is Banned</div>
                                            <div style="font-size: 14px; color: #666; margin-bottom: 4px;"><strong>Reason:</strong> <%= user.banReason || 'No reason provided' %></div>
                                            <div style="font-size: 13px; color: #999;"><strong>Banned:</strong> <%= new Date(user.bannedAt).toLocaleString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true }) %></div>
                                        </div>
                                    </div>
                                </div>
                            <% } %>
                        </div>
                        
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <% if (user.isBanned) { %>
                                <button onclick="showUnbanModal()" class="btn btn-success" style="white-space: nowrap;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px;">
                                        <path d="M9 12L11 14L15 10M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    Unban User
                                </button>
                            <% } else { %>
                                <button onclick="showBanModal()" class="btn btn-danger" style="white-space: nowrap;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px;">
                                        <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    Ban User
                                </button>
                            <% } %>
                            
                            <% if (user.isActive) { %>
                                <button onclick="showDeactivateModal()" class="btn btn-secondary" style="white-space: nowrap;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px;">
                                        <path d="M18.364 18.364C16.3734 20.3545 13.7189 21.4649 11 21.4649C8.28106 21.4649 5.62663 20.3545 3.63604 18.364C1.64545 16.3734 0.535156 13.7189 0.535156 11C0.535156 8.28106 1.64545 5.62663 3.63604 3.63604M18.364 18.364C20.3545 16.3734 21.4649 13.7189 21.4649 11C21.4649 8.28106 20.3545 5.62663 18.364 3.63604M18.364 18.364L3.63604 3.63604" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    Deactivate
                                </button>
                            <% } else { %>
                                <button onclick="showReactivateModal()" class="btn btn-primary" style="white-space: nowrap;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px;">
                                        <path d="M9 12L11 14L15 10M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    Reactivate
                                </button>
                            <% } %>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Statistics -->
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-number"><%= appointmentStats.total %></span>
                    <span class="stat-label">Total Appointments</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number"><%= appointmentStats.completed %></span>
                    <span class="stat-label">Completed</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number"><%= appointmentStats.cancelled %></span>
                    <span class="stat-label">Cancelled</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number">â‚±<%= totalSpent.toLocaleString() %></span>
                    <span class="stat-label">Total Spent</span>
                </div>
            </div>
            <!-- Business Information (if applicable) -->
            <% if (business) { %>
                <div class="card">
                    <div class="card-header">
                        <h3 style="display: flex; align-items: center; gap: 8px; margin: 0;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 7V3H2V21H22V7H12ZM6 19H4V17H6V19ZM6 15H4V13H6V15ZM6 11H4V9H6V11ZM6 7H4V5H6V7ZM10 19H8V17H10V19ZM10 15H8V13H10V15ZM10 11H8V9H10V11ZM10 7H8V5H10V7ZM20 19H12V17H14V15H12V13H14V11H12V9H20V19ZM18 11H16V13H18V11ZM18 15H16V17H18V15Z" fill="currentColor"/>
                            </svg>
                            Business Information
                        </h3>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 24px; margin-bottom: 20px;">
                            <div>
                                <div style="color: #666; font-size: 13px; margin-bottom: 4px;">Business Name</div>
                                <div style="font-weight: 600; font-size: 16px;"><%= business.businessName %></div>
                            </div>
                            <div>
                                <div style="color: #666; font-size: 13px; margin-bottom: 4px;">Status</div>
                                <span class="status-badge status-<%= business.verificationStatus %>"><%= business.verificationStatus %></span>
                            </div>
                            <div>
                                <div style="color: #666; font-size: 13px; margin-bottom: 4px;">Category</div>
                                <div style="font-weight: 600;"><%= business.category %></div>
                            </div>
                            <div>
                                <div style="color: #666; font-size: 13px; margin-bottom: 4px;">Phone</div>
                                <div style="font-weight: 600;"><%= business.contactNumber %></div>
                            </div>
                        </div>
                        <a href="/admin/businesses/<%= business._id %>" class="btn btn-primary">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px;">
                                <path d="M15 12C15 13.6569 13.6569 15 12 15C10.3431 15 9 13.6569 9 12C9 10.3431 10.3431 9 12 9C13.6569 9 15 10.3431 15 12Z" stroke="currentColor" stroke-width="2"/>
                                <path d="M2.45825 12C3.73253 7.94288 7.52281 5 12.0004 5C16.4781 5 20.2684 7.94291 21.5426 12C20.2684 16.0571 16.4781 19 12.0005 19C7.52281 19 3.73251 16.0571 2.45825 12Z" stroke="currentColor" stroke-width="2"/>
                            </svg>
                            View Business Details
                        </a>
                    </div>
                </div>
            <% } %>
            <!-- Recent Appointments -->
            <div class="card">
                <div class="card-header">
                    <h3 style="display: flex; align-items: center; gap: 8px; margin: 0;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M8 7V3M16 7V3M7 11H17M5 21H19C19.5304 21 20.0391 20.7893 20.4142 20.4142C20.7893 20.0391 21 19.5304 21 19V7C21 6.46957 20.7893 5.96086 20.4142 5.58579C20.0391 5.21071 19.5304 5 19 5H5C4.46957 5 3.96086 5.21071 3.58579 5.58579C3.21071 5.96086 3 6.46957 3 7V19C3 19.5304 3.21071 20.0391 3.58579 20.4142C3.96086 20.7893 4.46957 21 5 21Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Recent Appointments
                    </h3>
                </div>
                <div class="card-body">
                    <% if (recentAppointments.length === 0) { %>
                        <div style="text-align: center; padding: 60px 20px; color: #999;">
                            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" style="margin-bottom: 16px; opacity: 0.3;">
                                <path d="M8 7V3M16 7V3M7 11H17M5 21H19C19.5304 21 20.0391 20.7893 20.4142 20.4142C20.7893 20.0391 21 19.5304 21 19V7C21 6.46957 20.7893 5.96086 20.4142 5.58579C20.0391 5.21071 19.5304 5 19 5H5C4.46957 5 3.96086 5.21071 3.58579 5.58579C3.21071 5.96086 3 6.46957 3 7V19C3 19.5304 3.21071 20.0391 3.58579 20.4142C3.96086 20.7893 4.46957 21 5 21Z" fill="currentColor"/>
                            </svg>
                            <p style="font-size: 16px;">No appointments yet</p>
                        </div>
                    <% } else { %>
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Service</th>
                                    <th>Business</th>
                                    <th>Status</th>
                                    <th>Time</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% recentAppointments.forEach(apt => { %>
                                    <tr>
                                        <td><%= new Date(apt.date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) %></td>
                                        <td><%= apt.service?.name || 'N/A' %></td>
                                        <td><%= apt.businessId?.businessName || 'N/A' %></td>
                                        <td>
                                            <span class="status-badge status-<%= apt.status %>">
                                                <%= apt.status %>
                                            </span>
                                        </td>
                                        <td>
                                            <% 
                                            if (apt.timeSlot?.start) {
                                                const [hours, minutes] = apt.timeSlot.start.split(':');
                                                const hour = parseInt(hours);
                                                const ampm = hour >= 12 ? 'PM' : 'AM';
                                                const hour12 = hour % 12 || 12;
                                            %>
                                                <%= hour12 %>:<%= minutes %> <%= ampm %>
                                            <% } else { %>
                                                N/A
                                            <% } %>
                                        </td>
                                    </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    <% } %>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Modals -->
    <!-- Ban Modal -->
    <div class="kpi-modal" id="banModal" onclick="closeBanModal()">
        <div class="kpi-modal-content" onclick="event.stopPropagation()" style="max-width: 500px;">
            <button class="kpi-modal-close" onclick="closeBanModal()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
            <div class="kpi-modal-body">
                <div style="text-align: center; margin-bottom: 20px;">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: #f44336;">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                        <path d="M15 9L9 15M9 9L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </div>
                <h3 style="text-align: center; margin-bottom: 10px;">Ban User</h3>
                <p style="text-align: center; color: #666; margin-bottom: 20px;">
                    Are you sure you want to ban <strong><%= user.firstName %> <%= user.lastName %></strong>?
                </p>
                <form id="banForm" onsubmit="handleBan(event)">
                    <div style="margin-bottom: 20px;">
                        <label for="banReason" style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #1a1a1a;">
                            Reason for Ban <span style="color: #f44336;">*</span>
                        </label>
                        <textarea 
                            id="banReason" 
                            name="reason" 
                            required 
                            rows="4"
                            style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical;"
                            placeholder="Please provide a detailed reason for banning this user..."
                        ></textarea>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button type="button" class="btn btn-secondary" onclick="closeBanModal()" style="flex: 1;">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-danger" style="flex: 1;">
                            Ban User
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Unban Modal -->
    <div class="kpi-modal" id="unbanModal" onclick="closeUnbanModal()">
        <div class="kpi-modal-content" onclick="event.stopPropagation()" style="max-width: 500px;">
            <button class="kpi-modal-close" onclick="closeUnbanModal()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
            <div class="kpi-modal-body">
                <div style="text-align: center; margin-bottom: 20px;">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: #4CAF50;">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                        <path d="M8 12L11 15L16 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <h3 style="text-align: center; margin-bottom: 10px;">Unban User</h3>
                <p style="text-align: center; color: #666; margin-bottom: 20px;">
                    Are you sure you want to unban <strong><%= user.firstName %> <%= user.lastName %></strong>?
                </p>
                <p style="text-align: center; color: #999; font-size: 14px; margin-bottom: 20px;">
                    This user will be able to access their account again.
                </p>
                <div style="display: flex; gap: 12px;">
                    <button type="button" class="btn btn-secondary" onclick="closeUnbanModal()" style="flex: 1;">
                        Cancel
                    </button>
                    <button type="button" class="btn btn-success" onclick="handleUnban()" style="flex: 1;">
                        Unban User
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Deactivate Modal -->
    <div class="kpi-modal" id="deactivateModal" onclick="closeDeactivateModal()">
        <div class="kpi-modal-content" onclick="event.stopPropagation()" style="max-width: 500px;">
            <button class="kpi-modal-close" onclick="closeDeactivateModal()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
            <div class="kpi-modal-body">
                <div style="text-align: center; margin-bottom: 20px;">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: #ff9800;">
                        <path d="M12 9V13M12 17H12.01M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <h3 style="text-align: center; margin-bottom: 10px;">Deactivate User</h3>
                <p style="text-align: center; color: #666; margin-bottom: 20px;">
                    Are you sure you want to deactivate <strong><%= user.firstName %> <%= user.lastName %></strong>?
                </p>
                <div style="display: flex; gap: 12px;">
                    <button type="button" class="btn btn-secondary" onclick="closeDeactivateModal()" style="flex: 1;">
                        Cancel
                    </button>
                    <button type="button" class="btn btn-danger" onclick="handleDeactivate()" style="flex: 1;">
                        Deactivate
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reactivate Modal -->
    <div class="kpi-modal" id="reactivateModal" onclick="closeReactivateModal()">
        <div class="kpi-modal-content" onclick="event.stopPropagation()" style="max-width: 500px;">
            <button class="kpi-modal-close" onclick="closeReactivateModal()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
            <div class="kpi-modal-body">
                <div style="text-align: center; margin-bottom: 20px;">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: #4CAF50;">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                        <path d="M8 12L11 15L16 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <h3 style="text-align: center; margin-bottom: 10px;">Reactivate User</h3>
                <p style="text-align: center; color: #666; margin-bottom: 20px;">
                    Are you sure you want to reactivate <strong><%= user.firstName %> <%= user.lastName %></strong>?
                </p>
                <div style="display: flex; gap: 12px;">
                    <button type="button" class="btn btn-secondary" onclick="closeReactivateModal()" style="flex: 1;">
                        Cancel
                    </button>
                    <button type="button" class="btn btn-primary" onclick="handleReactivate()" style="flex: 1;">
                        Reactivate
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="kpi-modal" id="successModal" onclick="closeSuccessModal()">
        <div class="kpi-modal-content" onclick="event.stopPropagation()">
            <button class="kpi-modal-close" onclick="closeSuccessModal()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
            <div class="kpi-modal-body">
                <div style="text-align: center; margin-bottom: 20px;">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: #4CAF50;">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                        <path d="M8 12L11 15L16 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <h3 style="text-align: center; margin-bottom: 10px;">Success</h3>
                <p id="successMessage" style="color: #666; margin: 20px 0; text-align: center;"></p>
                <button type="button" class="btn btn-primary" onclick="window.location.reload()" style="width: 100%;">
                    OK
                </button>
            </div>
        </div>
    </div>

    <script>
        const userId = '<%= user._id %>';
        
        // Modal functions
        function showBanModal() {
            document.getElementById('banModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function closeBanModal() {
            document.getElementById('banModal').classList.remove('active');
            document.body.style.overflow = '';
        }
        
        function showUnbanModal() {
            document.getElementById('unbanModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function closeUnbanModal() {
            document.getElementById('unbanModal').classList.remove('active');
            document.body.style.overflow = '';
        }
        
        function showDeactivateModal() {
            document.getElementById('deactivateModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function closeDeactivateModal() {
            document.getElementById('deactivateModal').classList.remove('active');
            document.body.style.overflow = '';
        }
        
        function showReactivateModal() {
            document.getElementById('reactivateModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function closeReactivateModal() {
            document.getElementById('reactivateModal').classList.remove('active');
            document.body.style.overflow = '';
        }
        
        function closeSuccessModal() {
            document.getElementById('successModal').classList.remove('active');
            document.body.style.overflow = '';
        }
        
        function showSuccessModal(message) {
            document.getElementById('successMessage').textContent = message;
            document.getElementById('successModal').classList.add('active');
            document.body.style.overflow = 'hidden';
            
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        }
        
        // Action handlers
        async function handleBan(event) {
            event.preventDefault();
            const form = event.target;
            const reason = form.querySelector('[name="reason"]').value;

            try {
                const response = await fetch(`/admin/users/${userId}/ban`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason })
                });

                const data = await response.json();

                if (data.success) {
                    closeBanModal();
                    showSuccessModal(data.message || 'User has been banned successfully');
                } else {
                    alert('Error: ' + (data.error || 'Failed to ban user'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while banning the user');
            }
        }
        
        async function handleUnban() {
            try {
                const response = await fetch(`/admin/users/${userId}/unban`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.success) {
                    closeUnbanModal();
                    showSuccessModal(data.message || 'User has been unbanned successfully');
                } else {
                    alert('Error: ' + (data.error || 'Failed to unban user'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while unbanning the user');
            }
        }
        
        async function handleDeactivate() {
            try {
                const response = await fetch(`/admin/users/${userId}/deactivate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.success) {
                    closeDeactivateModal();
                    showSuccessModal(data.message || 'User has been deactivated successfully');
                } else {
                    alert('Error: ' + (data.error || 'Failed to deactivate user'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while deactivating the user');
            }
        }
        
        async function handleReactivate() {
            try {
                const response = await fetch(`/admin/users/${userId}/reactivate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.success) {
                    closeReactivateModal();
                    showSuccessModal(data.message || 'User has been reactivated successfully');
                } else {
                    alert('Error: ' + (data.error || 'Failed to reactivate user'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while reactivating the user');
            }
        }

        // Close modals on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeBanModal();
                closeUnbanModal();
                closeDeactivateModal();
                closeReactivateModal();
                closeSuccessModal();
            }
        });
    </script>
</body>
</html>
